<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Java Pod Dumps</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --panel-2: #1f2933;
      --border: #2d3748;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --danger: #ef4444;
      --radius: 10px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 32px;
      font-family: system-ui, -apple-system, Segoe UI, sans-serif;
      background: linear-gradient(180deg, #020617, #020617 200px, #020617);
      color: var(--text);
    }

    h2 {
      margin: 0 0 16px;
      font-weight: 600;
    }

    form {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 24px;
    }

    select {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: var(--radius);
    }

    button {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 8px 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.05s ease;
    }

    button:hover:not(:disabled) {
      background: var(--accent-hover);
    }

    button:active:not(:disabled) {
      transform: translateY(1px);
    }

    button:disabled {
      background: #374151;
      color: #9ca3af;
      cursor: not-allowed;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px;
    }

    th {
      text-align: left;
      font-size: 12px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
      padding: 8px 12px;
    }

    td {
      background: var(--panel);
      padding: 14px 12px;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }

    td:first-child {
      border-left: 1px solid var(--border);
      border-top-left-radius: var(--radius);
      border-bottom-left-radius: var(--radius);
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 13px;
    }

    td:last-child {
      border-right: 1px solid var(--border);
      border-top-right-radius: var(--radius);
      border-bottom-right-radius: var(--radius);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: #064e3b;
      color: #6ee7b7;
    }

    .actions {
      display: flex;
      gap: 12px;
    }

    .action {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .dump-button {
      min-width: 130px;
    }

    .status {
      font-size: 12px;
      color: var(--muted);
      min-height: 14px;
    }
  </style>

  <script>
    async function runDump(btn, payload) {
      const buttons = document.querySelectorAll(".dump-button");
      buttons.forEach(b => b.disabled = true);

      const status = btn.parentElement.querySelector(".status");
      status.textContent = "Please waitâ€¦";

      try {
        const resp = await fetch("/dump", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: new URLSearchParams(payload)
        });

        if (!resp.ok) {
          throw new Error("Dump failed");
        }

        const blob = await resp.blob();
        const filename =
          resp.headers.get("Content-Disposition")
            ?.split("filename=")[1]
            ?.replaceAll('"', "") || "dump";

        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      } catch (err) {
        alert(err.message);
      } finally {
        buttons.forEach(b => b.disabled = false);
        status.textContent = "";
      }
    }
  </script>
</head>
<body>

<h2>Pods in namespace: {{ namespace }}</h2>

<form method="get">
  Namespace:
  <select name="namespace">
    {% for ns in namespaces %}
      <option value="{{ ns }}" {% if ns == namespace %}selected{% endif %}>
        {{ ns }}
      </option>
    {% endfor %}
  </select>
  <button type="submit">Load</button>
</form>

<table>
  <tr>
    <th>Pod</th>
    <th>Status</th>
    <th>Actions</th>
  </tr>

  {% for pod in pods %}
  <tr>
    <td>{{ pod.metadata.name }}</td>

    <td>
      <span class="status-badge">
        {{ pod.status.phase }}
      </span>
    </td>

    <td>
      <div class="actions">
        <div class="action">
          <button
            class="dump-button"
            onclick="runDump(this, {
              pod: '{{ pod.metadata.name }}',
              namespace: '{{ namespace }}',
              container: '{{ pod.spec.containers[0].name }}',
              dump_type: 'thread'
            })"
          >
            Thread Dump
          </button>
          <div class="status"></div>
        </div>

        <div class="action">
          <button
            class="dump-button"
            onclick="runDump(this, {
              pod: '{{ pod.metadata.name }}',
              namespace: '{{ namespace }}',
              container: '{{ pod.spec.containers[0].name }}',
              dump_type: 'heap'
            })"
          >
            Heap Dump
          </button>
          <div class="status"></div>
        </div>
      </div>
    </td>
  </tr>
  {% endfor %}
</table>

</body>
</html>
